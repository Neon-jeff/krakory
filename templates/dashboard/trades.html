{% extends "dbase.html" %}
{%load static%}

{% block content %}

<section class='bg-black text-white max-md:pt-20' x-data="assets">
{% comment %} Coin data from request {% endcomment %}
{{ assets|json_script:"assets"}}
{{user|json_script:"user"}}
{{ assets|json_script:"assets"}}
{{trades|json_script:"trades"}}
{% include "components/sidenav.html" %}
{% include "components/loader.html" %}
{% include "components/error.html" %}
{% include "components/alerts.html" %}

{% comment %} main {% endcomment %}

<div class='ml-72 max-md:ml-0 p-5 '>

{% comment %} profile icon {% endcomment %}

<div class='max-md:hidden'>
{% include "components/path.html" %}
</div>
<h1 class="text-2xl font-medium">Trade Assets</h1>
{% comment %} main container {% endcomment %}

<div class='flex  gap-10 max-md:flex-col-reverse pt-10 h-full'>

{%include 'dashboard/trading-form.html'%}


{% comment %} Trade History {% endcomment %}
<div class='p-5 bg-sub w-full h-full rounded-md '>
<h1>Trades History</h1>
<div class="flex gap-5 text-sm py-5">
    <button class="bg-gray-800 p-5 rounded-md">Open </button>
<button class="bg-gray-800 p-5 rounded-md">Closed </button>
</div>

<!-- open trades wrappper -->
<div class="flex flex-col gap-5">
{% for trade in open_trades %}
<div class="flex justify-between  max-sm:text-xs gap-3 items-center bg-black p-5 rounded-md">
    <p class="flex flex-col gap-1"><span class="text-lg">${{trade.amount}}</span> <span>{{trade.created}}</span></p>
    <p>{{trade.currency}}</p>

    <p class="text-green-500">${{trade.take_profit}}</p>
    <p>Won</p>

</div>
{% endfor %}
</div>

<!-- closed trades wrapper -->



</div>
</div>
{% comment %} main end {% endcomment %}


{% comment %} Script {% endcomment %}
<script>

    document.addEventListener('alpine:init', () => {
         let form=new FormData(document.querySelector('form'))
        const assets = JSON.parse(document.getElementById("assets").textContent);
        const user = JSON.parse(document.getElementById("user").textContent);
        const trades = document.getElementById("trades").textContent
        console.log(trades);
        Alpine.data('assets', () => ({
            query:'',
            coins: assets,
            currentCoin:assets[0],
            setCurrentCoin(id){
                this.currentCoin=this.coins.find(item=>item.symbol==id)
                this.query=''
                this.show=false
                this.matchingCoins=this.coins.slice(0,6)
            },
            matchingCoins:assets.slice(0,6),
            updateCoins(){

                let result=this.coins.filter(
                    item=>{
                        return item.name.toLowerCase().startsWith(this.query.toLowerCase())
                    }
                )
                if (result.length>0 && this.query!=''){
                    this.matchingCoins=result
                    this.empty=false
                }
                else if(result.length==0){
                    this.matchingCoins=[]
                    this.empty=true
                }
                else{
                    this.matchingCoins=result.slice(0,6)
                }
            },
            empty:false,
            show:false,
            async submitForm(e){
                e.preventDefault()
                for(let i of form.keys()){
                    if(e.target[i]){
                        form.set(i,e.target[i].value)
                    }
                }
                form.set('currency',this.currentCoin.symbol)
                if(user.dollar_balance<=0 || user.dollar_balance<form.get("amount")){
                    this.errorMessage="Insufficient balance, make a deposit!"
                    this.showError=true
                }
                else{
                                    this.showLoader=true
                await fetch(`${window.location.href.replace("dashboard","trades")}`,{
                    body:form,
                    method:'post',
                }).then(async (res)=>{
                    let data=await res.json()
                    if (res.status==200){
                        await window.location.reload()

                    }
                })
                }
            },
            showLoader:false,
            showError:false,
            errorMessage:"Something went wrong",


        }))
    })
</script>
</section>

{% endblock content %}
